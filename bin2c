#!/usr/bin/perl
use warnings;
use Getopt::Std;

$| = 1; # make output unbuffered

my @arg = @ARGV;
$cmd = $0;
getopts("i:o:v:hVc", \%opts);
$prog_name = "Binary to C converter";
$prog_version = "v0.2";
$prog = $prog_name . " " . $prog_version;
$release_date = "2021-02-18";
$copy = "Copyright (C) Peter Ivanov <ivanovp_at_gmail_dot_com>, 2004, 2021";

if (keys(%opts)== 0 || $opts{h}) {
  usage();
}
if ($opts{V}) {
  print "$prog\n";
  print "Released: $release_date\n";
  exit;
}
if ($opts{c}) {
  copyright();
}
my $infile = '';
my $outfile = '';
my $variable = 'cBinary';

if ($opts{i}) {
    $infile = $opts{i};
}
if ($opts{o}) {
    $outfile = $opts{o};
}
else {
    $outfile = $infile;
    if (not $outfile =~ s/\.(.*)$/\.c/) {
        $outfile .= ".c";
    }
    if ($infile eq $outfile) {
    }
}
if ($opts{v}) {
    $variable = $opts{v};
}
print "$prog\n";
print "$copy\n";
print "\n";

print "Input file: $infile\n";
print "Output file: $outfile\n";
print "Variable name: $variable\n";
print "\n";

print "Opening $infile... ";
open (F1, "<", $infile) || die "Can't open file $infile: $!";
binmode (F1);
print "Ok.\n";
print "Opening $outfile... ";
open (F2, ">", $outfile) || die "Can't open file $outfile: $!";
print "Ok.\n";

print F2 "/*\n";
print F2 " * C file:      $outfile\n";
print F2 " * Binary file: $infile\n";
print F2 " * Command:     $cmd @arg\n";
print F2 " *\n";
print F2 " * This file generated by $prog\n";
print F2 " * $copy\n";
print F2 " */\n";
print F2 "\n";
print F2 "const char " . $variable . "[] = \n";
print F2 "{\n";

print "Converting... ";
my $n = 0;
while (my $len = read (F1, $buf, 8)) {
    $n += $len;
    my $first = 1;
    foreach $c (split //, $buf) {
        if ($first) {
            $first = 0;
        }
        else {
            print F2 ", ";
        }
        printf F2 "0x%02X", ord ($c);
    }
    print F2 ", " if (!eof (F1));
    print F2 "\n";
}
print F2 "};\n";

print "$n byte(s) done.\n";

close F2;
close F1;

print "Exiting...\n\n";
exit 0;

##############################################################################
sub usage
{
    die<<"EOT";
$prog
$copy

This program comes with ABSOLUTELY NO WARRANTY; for details type `$cmd -c'.
This is free software, and you are welcome to redistribute it
under certain conditions; type `$cmd -c' for details.

Usage: $cmd [-i <infile>]  [-o <outfile.c>] [-v <variable>] [-h -V -c]
Options:
  -i: input file (binary)
  -o: output file (C source)
  -v: variable name
  -h: prints help
  -V: prints version
  -c: prints copyright informations
EOT
}

sub copyright
{
    die<<"EOT";
$prog
$copy

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

EOT
    exit;
}

